generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────

enum Role {
  ADMIN
  USER

  @@map("oven_role")
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED

  @@map("oven_user_status")
}

enum OvenType {
  NON_AQUEOUS
  AQUEOUS

  @@map("oven_type")
}

enum OvenStatus {
  AVAILABLE
  MAINTENANCE

  @@map("oven_status")
}

enum BookingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  AUTO_CANCELLED

  @@map("oven_booking_status")
}

enum BookingEventType {
  CREATED
  EDITED
  CANCELLED
  AUTO_CANCELLED
  COMPLETED
  REMOVED

  @@map("oven_booking_event_type")
}

enum BookingActorType {
  USER
  ADMIN
  SYSTEM

  @@map("oven_booking_actor_type")
}

// ─── Models ──────────────────────────────────────────────────────────

model User {
  id           String     @id @default(uuid())
  name         String
  email        String     @unique
  phone        String     @unique
  nickname     String?
  nim          String?    @unique
  supervisors  String[]
  hasSeenTour  Boolean    @default(false)
  image        String?    @db.Text
  passwordHash String     @map("password_hash")
  role         Role       @default(USER)
  status       UserStatus @default(PENDING)
  isContactPerson Boolean @default(false) @map("is_contact_person")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  bookings          Booking[]
  cancelledBookings Booking[]     @relation("booking_cancelled_by")
  deletedBookings   Booking[]     @relation("booking_deleted_by")
  bookingEvents     BookingEvent[] @relation("booking_event_actor")

  @@map("oven_users")
}

model Oven {
  id          Int        @id @default(autoincrement())
  name        String
  type        OvenType
  status      OvenStatus @default(AVAILABLE)
  description String?
  maxTemp     Int        @default(200) @map("max_temp")

  bookings Booking[]

  @@map("oven_ovens")
}

model Booking {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  ovenId    Int           @map("oven_id")
  startDate DateTime      @map("start_date")
  endDate   DateTime      @map("end_date")
  purpose   String
  usageTemp Int           @default(0) @map("usage_temp")
  flap      Int           @default(0)
  status    BookingStatus @default(ACTIVE)
  cancelledAt   DateTime? @map("cancelled_at")
  cancelledById String?   @map("cancelled_by_id")
  cancelReason  String?   @map("cancel_reason")
  deletedAt     DateTime? @map("deleted_at")
  deletedById   String?   @map("deleted_by_id")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  oven Oven @relation(fields: [ovenId], references: [id])
  cancelledBy User? @relation("booking_cancelled_by", fields: [cancelledById], references: [id])
  deletedBy User? @relation("booking_deleted_by", fields: [deletedById], references: [id])
  events BookingEvent[]

  @@index([ovenId, startDate, endDate])
  @@index([deletedAt])
  @@map("oven_bookings")
}

model BookingEvent {
  id        String           @id @default(uuid())
  bookingId String           @map("booking_id")
  actorId   String?          @map("actor_id")
  actorType BookingActorType @default(SYSTEM) @map("actor_type")
  eventType BookingEventType @map("event_type")
  note      String?
  payload   Json?
  createdAt DateTime         @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  actor   User?   @relation("booking_event_actor", fields: [actorId], references: [id])

  @@index([bookingId, createdAt])
  @@index([actorId, createdAt])
  @@map("oven_booking_events")
}
